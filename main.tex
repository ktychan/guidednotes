\documentclass[12pt, letterpaper]{book}

% ----------------------------------------
% 
% Course information
%
% ----------------------------------------
\def\theauthor{AUTHOR}
\def\theinstitute{UNIVERSITY}
\def\thecourseterm{TERM}
\def\thecourseyear{YEAR}
\def\thecoursesubj{SUBJ}        % subject abbreviation
\def\thecoursesubject{SUBJECT}
\def\thecoursenumb{1000}
\def\thecoursesect{}
\def\thecoursename{COURSE NAME}
\def\thecoursetitle{\thecoursesubj~\thecoursenumb~\thecoursesect: \thecoursename}
\def\thecoursecoordinator{}
\def\thecourseinstructor{\theauthor}
\def\thecourselms{}

\def\thecoursetextbooktitle{}
\def\thecoursetextbookurl{}
\def\thecoursetextbookpublisher{}
\def\thecoursetextbook{}

% ------------------------------------------------------------
%
%             TITLE
%
% ------------------------------------------------------------
\title{\thecoursetitle}
\author{\theauthor}
\date{\today}


% ------------------------------------------------------------
%
%             PAGE SETUP
%
% ------------------------------------------------------------
\usepackage[margin=0.75in, top=0.25in, bottom=0.25in, nofoot, nomarginpar, includehead, includefoot, headheight=15pt, footskip=5pt]{geometry}

% header and footers
\usepackage{fancyhdr} % must be loaded after geometry

% base style for all pages
\fancypagestyle{base}{
  \fancyhf{}
  \fancyhead[OR, EL]{\small Page~\thepage}
  \renewcommand{\headrulewidth}{0pt}
}
\pagestyle{base}

\fancypagestyle{draft}[base]{
  \fancyhead[OL, ER]{\small \hlwarn{Draft}}
  \renewcommand{\headrulewidth}{.4pt}
}

% base style for the first page of a chapter
\newcommand{\firstpageheader}{}
\fancypagestyle{firstpage}[base]{
  \fancyhead[OL, ER]{\small \thecoursesubj{}~\thecoursenumb~(\thecourseterm~\thecourseyear)}
  \fancyhead[C]{\small\firstpageheader{}}
  \renewcommand{\headrulewidth}{.4pt}
}

% for syllabus
\fancypagestyle{syllabus}[firstpage]{
  \fancyhead[C]{\small Syllabus}
}

% ------------------------------------------------------------
%
%           PACKAGES
%
% ------------------------------------------------------------
% colours
\input{./colours.tex.preamble}

% math
\usepackage{amsmath, amsthm, amssymb, amsfonts}
\usepackage{cancel}
\everymath{\displaystyle}

% typography
\usepackage{fontspec}
\usepackage{microtype} 
\usepackage{parskip}
\usepackage{ragged2e}

% embedded markups
\usepackage{markdown}

% subfiles
\usepackage{refcount, xr, subfiles}

% links and references
\usepackage[hidelinks, pdfusetitle]{hyperref}
\renewcommand{\UrlFont}{\footnotesize\ttfamily}

% lists
\usepackage[inline]{enumitem}

% figures
\usepackage{float}

% plots
\input{./tikz.tex.preamble}

% tables
\usepackage{booktabs}

% framed callout boxes
\usepackage[framemethod=tikz]{mdframed}
\mdfdefinestyle{wide}{
  % userdefinedwidth=0.95\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
}
\mdfdefinestyle{simple}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
  startinnercode={\linespread{1.5}\selectfont}
}

\mdfdefinestyle{simple-compact}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
}

\mdfdefinestyle{sidenote}{
  userdefinedwidth=0.3\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=1em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=right,
  topline=false,
  rightline=false,
  bottomline=false,
  startinnercode={\footnotesize}
}

\mdfdefinestyle{withref}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=0.25em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
  startinnercode={\linespread{1.5}\selectfont}
}

\mdfdefinestyle{withref-compact}{
  userdefinedwidth=0.9\textwidth,
  innertopmargin=1em,
  innerleftmargin=1em,
  innerbottommargin=0.25em,
  innerrightmargin=1em,
  skipabove=1em,
  skipbelow=1em,
  align=center,
  roundcorner=3pt,
}

% fonts
\usepackage[mathcal]{euscript}
\usepackage{fontawesome5}

% section titles
\usepackage[sc,center,tiny]{titlesec}
\titlelabel{\thetitle.\;}
% \titleformat{⟨command⟩}[⟨shape⟩]{⟨format⟩}{⟨label⟩}{⟨sep⟩}{⟨before-code⟩}[⟨after-code⟩]
\titleformat{\subsection}{\bfseries}{\thesubsection}{1ex}{}{}
\titleformat{\subsubsection}{}{\thesubsection}{1ex}{}{}


% ------------------------------------------------------------
%
%           Math
%
% ------------------------------------------------------------
\numberwithin{equation}{chapter}
\theoremstyle{definition}
\newtheorem{thm}{Theorem}
\newtheorem{example}[thm]{Example}

\newcommand{\textbook}[1]{\noindent{} {\footnotesize \faBookReader{} #1 \hfill}}

% better looking symbols
\renewcommand{\epsilon}{\varepsilon}
\renewcommand{\emptyset}{\varnothing}
\renewcommand{\arctan}{\tan^{-1}}
\renewcommand{\arcsin}{\sin^{-1}}
\renewcommand{\arccos}{\cos^{-1}}


% ------------------------------------------------------------
%
%           Fill in the blanks
%
% ------------------------------------------------------------
\usepackage{suffix}
\newcommand{\blanklines}[1]{
  \par
  \includegraphics{./standalones/build/grid_#1_by_40.pdf}
  \smallbreak
}


% ------------------------------------------------------------
%
%           Make a week environment
%
% ------------------------------------------------------------
\newcounter{week}
\setcounter{week}{0}
\newenvironment{week}[1]{
  \refstepcounter{week}

  % befor code
  % chapter and section numbering
  \setcounter{chapter}{\theweek}
  \setcounter{section}{0}
  \setcounter{thm}{0}

  % add to TOC
  \phantomsection{}\label{week\theweek}
  \addcontentsline{toc}{chapter}{Week~\theweek~(#1)}

  \renewcommand{\firstpageheader}{Week~\theweek~(#1)}
  \thispagestyle{firstpage}
}{
  \clearpage{\thispagestyle{empty}\cleardoublepage}
  \renewcommand{\firstpageheader}{}
  \directlua{weeks[\theweek] = \the\value{page}}
}

% ------------------------------------------------------------
%
%         Keep track of page numbering of the weeks
%
% ------------------------------------------------------------
\usepackage{luacode}
\directlua{weeks = {}}

\begin{document}
  % --------------------
  % 
  % TITLE PAGE
  % 
  % --------------------
  \begin{titlepage}
    \thispagestyle{empty}
    \huge
    
    \begin{center}
      % title
      \phantom{top}
      \vspace{1in}

      {\Huge\bfseries \thecoursetitle}

      \vspace{1cm}
      \theauthor

      \theinstitute
      \vfill{}

      \thecourseterm~\thecourseyear

      \vspace{2in}
    \end{center}

    % creaate a blank page
    \clearpage{\thispagestyle{empty}\cleardoublepage}
  \end{titlepage}
  \directlua{titlepage = \the\value{page} - 1}  % has be the line immediaately after \end{titlepage}

  % --------------------
  % 
  % FRONT MATTER
  % 
  % --------------------
  \frontmatter{}
  \pagenumbering{roman}
  
  \renewcommand{\contentsname}{Table of Contents}
  \phantomsection{} \label{toc}
  \addcontentsline{toc}{chapter}{\contentsname}
  \tableofcontents{}
  \clearpage

  \clearpage{\thispagestyle{empty}\cleardoublepage}
  \directlua{frontmatter = \the\value{page} - 1}  % has to be the last line of the front matter

  %--------------------
  % 
  % MAIN MATTER
  % 
  % --------------------
  \mainmatter{}

  \begin{week}{MONTH X to X}
    placeholder
  \end{week}

  \begin{week}{MONTH X to X}
    placeholder
  \end{week}

  %--------------------
  % 
  % BACK MATTER
  % 
  % --------------------
  \backmatter{}

  %--------------------
  % 
  % generate files in the publish direjctory
  % 
  % --------------------
  \begin{luacode}
    local offset = titlepage + frontmatter
    local prev = offset + 1
    for i, pagenum in pairs(weeks) do
    local f = io.open(string.format("./publish/week%d.tex", i), "w")
    local a = prev
    local b = pagenum + offset - 1
    local s = string.format("\\includepdf[pages=%d-%d]{../build/main.pdf}", a, b)

    f:write("\\documentclass{article}")
    f:write("\\usepackage{pdfpages}")
    f:write("\\begin{document}")
    f:write(s)
    f:write("\\end{document}")
    f:close()

    prev = b + 1
    end
  \end{luacode}
\end{document}
